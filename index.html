<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Реальный анализ изображений</title>
<style>
body { font-family: Roboto, sans-serif; background: #f5f5f5; text-align: center; margin: 20px; }
canvas { border: 1px solid #ccc; margin: 10px; }
button { padding: 10px 20px; font-size: 16px; margin: 10px; border-radius: 5px; box-shadow: 1px 1px 5px #aaa; cursor: pointer; }
#results { margin-top: 20px; font-size: 16px; }
.legend { display: flex; justify-content: center; margin-top:10px; gap:10px; font-size:14px; }
.legend div { padding: 2px 6px; border-radius: 3px; color:#fff; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Реальный анализ изображений</h2>

<input type="file" id="file1">
<input type="file" id="file2"><br>

<canvas id="canvas1" width="400" height="300"></canvas>
<canvas id="canvas2" width="400" height="300"></canvas>
<canvas id="diffCanvas" width="400" height="300"></canvas><br>

<button onclick="analyze()">Анализировать</button>

<div id="results"></div>
<div class="legend">
    <div style="background:red;">Красный = отличие по яркости</div>
    <div style="background:blue;">Синий = отличие по цвету</div>
    <div style="background:green;">Зелёный = совпадение</div>
    <div style="background:magenta;">Ярко-фиолет = сильное отличие (цвет+яркость)</div>
</div>

<canvas id="chart" width="400" height="300"></canvas>

<script>
let ctx1, ctx2, diffCtx;
let chartInstance = null;
let img1 = new Image(), img2 = new Image();

document.getElementById('file1').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    img1.src = URL.createObjectURL(file);
});
document.getElementById('file2').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    img2.src = URL.createObjectURL(file);
});

img1.onload = ()=> {
    ctx1 = document.getElementById('canvas1').getContext('2d');
    ctx1.drawImage(img1, 0, 0, 400, 300);
}
img2.onload = ()=> {
    ctx2 = document.getElementById('canvas2').getContext('2d');
    ctx2.drawImage(img2, 0, 0, 400, 300);
}

diffCtx = document.getElementById('diffCanvas').getContext('2d');

function analyze(){
    if(!ctx1 || !ctx2){ alert("Загрузите оба изображения!"); return; }

    const width = 400, height = 300;
    let imgData1 = ctx1.getImageData(0,0,width,height);
    let imgData2 = ctx2.getImageData(0,0,width,height);
    let overlay = diffCtx.createImageData(width,height);

    let colorDiffPixels = 0, brightDiffPixels = 0, matchPixels = 0;
    const totalPixels = width*height;

    const brightThreshold = 0.2; // нормализованные 0-1
    const colorThreshold = 0.2;

    for(let i=0;i<imgData1.data.length;i+=4){
        let r1=imgData1.data[i], g1=imgData1.data[i+1], b1=imgData1.data[i+2];
        let r2=imgData2.data[i], g2=imgData2.data[i+1], b2=imgData2.data[i+2];

        let bright1 = 0.299*r1 + 0.587*g1 + 0.114*b1;
        let bright2 = 0.299*r2 + 0.587*g2 + 0.114*b2;
        let brightDelta = Math.abs(bright1 - bright2)/255;

        let dr = Math.abs(r1-r2)/255;
        let dg = Math.abs(g1-g2)/255;
        let db = Math.abs(b1-b2)/255;
        let colorDelta = (dr+dg+db)/3;

        // Подсчет пикселей для графика
        let isBrightDiff = brightDelta > brightThreshold;
        let isColorDiff = colorDelta > colorThreshold;

        if(isBrightDiff && isColorDiff){
            overlay.data[i]=255; overlay.data[i+1]=0; overlay.data[i+2]=255; // ярко-фиолет
        } else if(isBrightDiff){
            overlay.data[i]=255; overlay.data[i+1]=0; overlay.data[i+2]=0; // красный
        } else if(isColorDiff){
            overlay.data[i]=0; overlay.data[i+1]=0; overlay.data[i+2]=255; // синий
        } else {
            overlay.data[i]=0; overlay.data[i+1]=255; overlay.data[i+2]=0; // зелёный = совпадение
        }
        overlay.data[i+3]=120;

        if(isBrightDiff) brightDiffPixels++;
        if(isColorDiff) colorDiffPixels++;
        if(!isBrightDiff && !isColorDiff) matchPixels++;
    }

    diffCtx.putImageData(overlay,0,0);

    let colorPercent = (1 - colorDiffPixels/totalPixels)*100;
    let brightnessPercent = (1 - brightDiffPixels/totalPixels)*100;
    let similarity = (matchPixels/totalPixels)*100;

    document.getElementById('results').innerHTML=
        `<b>Overall Similarity:</b> ${similarity.toFixed(2)}%<br>`+
        `<b>Color Match:</b> ${colorPercent.toFixed(2)}%<br>`+
        `<b>Brightness Match:</b> ${brightnessPercent.toFixed(2)}%<br>`;

    // Chart.js
    const chartCanvas = document.getElementById('chart');
    if(chartCanvas){
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(chartCanvas,{
            type:'bar',
            data:{
                labels:['Overall','Color','Brightness'],
                datasets:[{
                    label:'Similarity %',
                    data:[similarity,colorPercent,brightnessPercent],
                    backgroundColor:['green','blue','red']
                }]
            },
            options:{
                responsive:true,
                scales:{
                    y:{min:0,max:100,title:{display:true,text:'% Similarity'}},
                    x:{title:{display:true,text:'Metrics'}}
                }
            }
        });
    }
}
</script>
</body>
</html>
